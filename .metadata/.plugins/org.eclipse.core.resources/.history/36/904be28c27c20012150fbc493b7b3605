package edu.nchu.cs.news;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import android.content.Context;
import android.util.Log;


public class NewsDbModel {
    
    private NewsDbConnector db;
    private static final String ACTIVITY_TAG = "Database";

    public void NewsDataModel(Context context){
        db = new NewsDbConnector(context);
        del_cache_over_time();
    }

    public HashMap<String, String>[] newslist_today() {
        String token = db.systemGetByIndex("index");
        String url = "get=today&token=" + token ;
        return get_list(url);
    }

    public Object newslist_day(String date) {
        String url = "get=list&date=" + date;
        return get_list(url);
    } 

    public Object newslist_cate_day(int rid, String date) {
        String url = "get=list&rid=" + rid + "&date=" + date;
        return get_list(url);
    }

    public  HashMap<String, String>[] cnt_day(String date) throws JSONException, Exception {

        String url = "get=cnt&group=date" + date;
        JSONObject jsonObj = fetch_srv_files(url);

        if(jsonObj.getString("cntCnt").equals("0"))
            throw new Exception("No match news.");
        
        JSONArray jsonArray = jsonObj.getJSONArray("list");
        int cnt = Integer.valueOf(jsonObj.getString("cntCnt")); 
        HashMap<String, String>[] list = new HashMap<String, String> ;

        for(int i=0;i<cnt;i++){
            JSONObject obj = jsonArray.getJSONObject(i);

            Map<String, String> map = new HashMap<String, String>();
            map.put("date",      obj.getString("date"));
            map.put("cnt",    obj.getString("cnt"));
            list[i] = map;
        }

        return list;
    }

    public Map[] cnt_cate(int rid) throws JSONException, Exception {

        String url = "get=cnt&group=rid" + rid;
        JSONObject jsonObj = fetch_srv_files(url);

        if(jsonObj.getString("cntCnt").equals("0"))
            throw new Exception("No match news.");
        
        JSONArray jsonArray = jsonObj.getJSONArray("list");
        int cnt = Integer.valueOf(jsonObj.getString("cntCnt")); 
        Map[] list = new Map[cnt];

        for(int i=0;i<cnt;i++){
            JSONObject obj = jsonArray.getJSONObject(i);

            Map<String, String> map = new HashMap<String, String>();
            map.put("rid",      obj.getString("rid"));
            map.put("cnt",    obj.getString("cnt"));
            list[i] = map;
        }

        return list;
    }

    public void cache_today_news() {

        Map[] list = newslist_today();
        int cnt = list.length;
        String nid = "0";

         for(int i=0;i<cnt;i++) {
            Map<String, String> map = list[i];
            nid = map.get("nid");
            cache_news(nid);
         }

    }



    public Map<String, String> system_argu(String index, String value) {

        if ( value == null) {
            Map<String, String> map = new HashMap<String, String>();
            map.put(index, db.systemGetByIndex(index));
            return map;
        }

        else {
            if(db.systemGetByIndex(index) = null) {
                db.systemPut(index, value);
            }
            else {
                db.systemSet(index, value);
            }
        }

    }

    public Map<String, String> get_news(int nid) {

        try {
            Map<String, String> map;    

            if(nid == 0) 
                throw new Exception("Nid Can't be zero.");

            if ( db.newsGetById(nid) != null ) {
                map = db.newsGetById(nid);
            }
            else {
                map = cache_news(nid);
                db.newsPut(map);
            }

            return map;

        }
        catch( Exception e ) {
            Log.e(ACTIVITY_TAG,e.toString());
        }
        
    }

    private Map<String, String>[] get_list(String url) {

        JSONObject jsonObj = fetch_srv_files(url);

        if((jsonObj).getString("listCnt").equals("0"))
            throw new Exception("No match news.");
        
        JSONArray jsonArray = jsonObj.getJSONArray("list");
        String cnt = jsonObj.getString("listCnt");
        Map[] list = new Map[cnt];

        for(int i=0;i<cnt;i++){
            JSONObject obj = jsonArray.getJSONObject(i);

            Map<String, String> map = new HashMap<String, String>();
            map.put("nid",      obj.getString("nid"));
            map.put("title",    obj.getString("title"));
            map.put("news_t",   obj.getString("news_t"));

            list[i] = map;
        }

        return list;
    }


    private Map<String, String> cache_news(int nid) {

        try {
            String url = "get=news&nid=" + nid;
            JSONObject jsonObj = fetch_srv_files(url);

            if(jsonObj.getString("newsCnt").equals("0"))
                throw new Exception("No match news.");
            
            JSONArray jsonArray = jsonObj.getJSONArray("news");
            JSONObject obj = jsonArray.getJSONObject(0);

            Map<String, String> map = new HashMap<String, String>();
            map.put("nid",      obj.getString("nid"));
            map.put("title",    obj.getString("title"));
            map.put("article",  obj.getString("article"));
            map.put("news_t",   obj.getString("news_t"));
            map.put("url",      obj.getString("url"));

            return map;
        }
        catch( Exception e ) {
            Log.e(ACTIVITY_TAG,e.toString());
        }
    }

    private void del_cache_over_time() {
        int days = db.systemGetByIndex("cache_exist_time");
        List<String> id_arr = getOverTimeNewsId(days);

        for (int i = 0; i < id_arr.size(); i++) {
        	db.newsDelById(id_arr.get(i));
        }

    }

    private JSONObject fetch_srv_files(String api_url) {

        try {
            String jsonHtml = getUriContent( api_url );

            if(jsonHtml.length()==0)
                throw new Exception("Server didn't send json data.");

            JSONObject jsonObject = new JSONObject(jsonHtml);

            if(!jsonObject.isNull("error"))
                throw new Exception("Server Error.");     

            return jsonObject;
        }
        catch( Exception e ) {
            Log.e(ACTIVITY_TAG,e.toString());
        }
    }

}
