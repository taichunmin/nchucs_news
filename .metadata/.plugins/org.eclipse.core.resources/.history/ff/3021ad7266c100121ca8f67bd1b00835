package edu.nchu.cs.news;



public class newsDataModel {
    
    
    public NewsDataModel(Context context){
        NewsDbConnector db = new NewsDbConnector();
        del_cache_over_time();
    }

    public newslist_today() {
        String token = db.systemGetByIndex("index");
        String url = "get=today&token=" + token ;
        return get_list(url);
    }

    public newslist_day(String date) {
        String url = "get=list&date=" + date;
        return get_list(url);
    } 

    public newslist_cate_day(int rid, String date) {
        String url = "get=list&rid=" + rid + "&date=" + date;
        return get_list(url);
    }

    public cnt_day(String date) {

        String url = "get=cnt&group=date" + date;
        Object jsonObj = fetch_srv_files(url);

        // 檢查 news 的數量
        if(jsonObject.getString("cntCnt").equals("0"))
            throw new Exception("No match news.");
        
        JSONArray jsonArray = jsonObject.getJSONArray("list");
        int cnt = jsonObject.getString("cntCnt")
        Map[] list = new Map[cnt];

        for(int i=0;i<cnt;i++){
            JSONObject obj = jsonArray.getJSONObject(i);

            Map<String, String> map = new HashMap<String, String>();
            map.put("date",      obj.getString("date"));
            map.put("cnt",    obj.getString("cnt"));
            list[i] = map;
        }

        return list;
    }

    public cnt_cate(int rid) {

        String url = "get=cnt&group=rid" + rid;
        Object jsonObj = fetch_srv_files(url);

        // 檢查 news 的數量
        if(jsonObject.getString("cntCnt").equals("0"))
            throw new Exception("No match news.");
        
        JSONArray jsonArray = jsonObject.getJSONArray("list");
        int cnt = jsonObject.getString("cntCnt")
        Map[] list = new Map[cnt];

        for(int i=0;i<cnt;i++){
            JSONObject obj = jsonArray.getJSONObject(i);

            Map<String, String> map = new HashMap<String, String>();
            map.put("rid",      obj.getString("rid"));
            map.put("cnt",    obj.getString("cnt"));
            list[i] = map;
        }

        return list;
    }

    public cache_today_news() {

        Map[] list = newslist_today();
        int cnt = list.length;
        int nid = 0;

         while(int i=0;i<cnt;i++) {
            Map<String, String> map = list[i];
            nid = map.get("nid");
            cache_news(nid);
         }

    }



    public system_argu(String index, String value = null) {

        // Get Mode
        if ( process == null) {
            Map<String, String> map = new HashMap<String, String>();
            map.put(index, db.systemGetByIndex(index));
            return map;
        }

        // Set Mode
        else {
            if(db.systemGetByIndex(index) = null) {
                db.systemPut(index, value);
            }
            else {
                db.systemSet(index, value)
            }
        }

    }

    public get_news(int nid) {

        try {
            Map<String, String> map;    

            // 檢查 NID 的正確性
            if(nid == 0) 
                throw new Exception("Nid Can't be zero.");

            // 如果資料庫快取已有存在資料
            if ( newsGetById(nid) != null ) {
                map = newsGetById(nid);
            }

            // 若沒有快取則從Server抓取
            else {
                map = cache_news(nid);
                db.newsPut(map);
            }

            return map;

        }
        catch( Exception e ) {
            Log.e(ACTIVITY_TAG,e.toString());
        }
        
    }

    private get_list(String url) {

        Object jsonObj = fetch_srv_files(url);

        // 檢查 news 的數量
        if(jsonObject.getString("listCnt").equals("0"))
            throw new Exception("No match news.");
        
        JSONArray jsonArray = jsonObject.getJSONArray("list");
        int cnt = jsonObject.getString("listCnt")
        Map[] list = new Map[cnt];

        for(int i=0;i<cnt;i++){
            JSONObject obj = jsonArray.getJSONObject(i);

            Map<String, String> map = new HashMap<String, String>();
            map.put("nid",      obj.getString("nid"));
            map.put("title",    obj.getString("title"));
            map.put("news_t",   obj.getString("news_t"));

            list[i] = map;
        }

        return list;
    }


    private cache_news(int nid) {

        try {
            String url = "get=news&nid=" + nid;
            Object jsonObj = fetch_srv_files(url);

            // 檢查 news 的數量
            if(jsonObject.getString("newsCnt").equals("0"))
                throw new Exception("No match news.");
            
            JSONArray jsonArray = jsonObject.getJSONArray("news");
            JSONObject obj = jsonArray.getJSONObject(0);

            Map<String, String> map = new HashMap<String, String>();
            map.put("nid",      obj.getString("nid"));
            map.put("title",    obj.getString("title"));
            map.put("article",  obj.getString("article"));
            map.put("news_t",   obj.getString("news_t"));
            map.put("url",      obj.getString("url"));

            return map;
        }
        catch( Exception e ) {
            Log.e(ACTIVITY_TAG,e.toString());
        }
    }

    private del_cache_over_time() {
        int days = newsGetById("cache_exist_time");
        List<String> id_arr = getOverTimeNewsId(days);

        for (int i = 0; i < id_arr.size(); i++) {
            db.newsDelById(id_arr.get(i));
        }

    }

    private fetch_srv_files(String api_url) {

        try {
            // 抓取資料 in JSON
            String jsonHtml = getUriContent( api_url );

            // 檢查從伺服器取得的 JSON 不為空
            if(jsonHtml.length()==0)
                throw new Exception("Server didn't send json data.");

            // 將 JSON 字串轉為 JSONObject
            JSONObject jsonObject = new JSONObject(jsonHtml);

            // 確認 JSON 中不含錯誤訊息
            if(!jsonObject.isNull("error"))
                throw new Exception("Server Error.");     

            return jsonObject;
        }
        catch( Exception e ) {
            Log.e(ACTIVITY_TAG,e.toString());
        }            
    }

}
